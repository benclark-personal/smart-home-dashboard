<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Home Temperature Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 300;
      margin-bottom: 10px;
    }

    .header .last-update {
      font-size: 0.9rem;
      color: #888;
    }

    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .stat {
      text-align: center;
      padding: 15px 25px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      min-width: 150px;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 600;
    }

    .stat-room {
      font-size: 0.8rem;
      color: #666;
      margin-top: 3px;
    }

    .stat.average .stat-value { color: #4fc3f7; }
    .stat.warmest .stat-value { color: #ff7043; }
    .stat.coldest .stat-value { color: #29b6f6; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .room-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 20px;
      transition: transform 0.2s, background 0.2s;
    }

    .room-card:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.12);
    }

    .room-card.outdoor {
      background: rgba(100, 181, 246, 0.15);
      border: 1px solid rgba(100, 181, 246, 0.3);
    }

    .room-card.console {
      background: rgba(255, 193, 7, 0.15);
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .room-name {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 15px;
      color: #ccc;
    }

    .temperature {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .temperature .unit {
      font-size: 1.2rem;
      font-weight: 400;
      color: #888;
    }

    .humidity {
      font-size: 1rem;
      color: #64b5f6;
    }

    .battery {
      font-size: 0.8rem;
      color: #888;
      margin-top: 10px;
    }

    .battery.low {
      color: #ff5252;
    }

    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .no-data h2 {
      margin-bottom: 10px;
      font-weight: 400;
    }

    .floor-section {
      margin-bottom: 30px;
    }

    .floor-title {
      font-size: 1.1rem;
      font-weight: 500;
      color: #666;
      margin-bottom: 15px;
      padding-left: 5px;
      border-left: 3px solid #4fc3f7;
    }

    .refresh-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 24px;
      background: rgba(79, 195, 247, 0.2);
      border: 1px solid rgba(79, 195, 247, 0.4);
      border-radius: 8px;
      color: #4fc3f7;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .refresh-btn:hover {
      background: rgba(79, 195, 247, 0.3);
    }

    .refresh-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Colour coding based on temperature */
    .temp-cold { color: #29b6f6; }
    .temp-cool { color: #4fc3f7; }
    .temp-comfortable { color: #81c784; }
    .temp-warm { color: #ffb74d; }
    .temp-hot { color: #ff7043; }

    @media (max-width: 768px) {
      .stats-bar {
        gap: 15px;
      }

      .stat {
        min-width: 100px;
        padding: 10px 15px;
      }

      .stat-value {
        font-size: 1.4rem;
      }

      .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .room-card {
        padding: 15px;
      }

      .temperature {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Smart Home Temperature</h1>
    <div class="last-update" id="lastUpdate">Loading...</div>
  </div>

  <div class="stats-bar" id="statsBar">
    <div class="stat average">
      <div class="stat-label">House Average</div>
      <div class="stat-value" id="avgTemp">--</div>
    </div>
    <div class="stat warmest">
      <div class="stat-label">Warmest</div>
      <div class="stat-value" id="warmestTemp">--</div>
      <div class="stat-room" id="warmestRoom">--</div>
    </div>
    <div class="stat coldest">
      <div class="stat-label">Coldest</div>
      <div class="stat-value" id="coldestTemp">--</div>
      <div class="stat-room" id="coldestRoom">--</div>
    </div>
  </div>

  <div id="roomGrid" class="no-data">
    <h2>Loading sensor data...</h2>
    <p>Waiting for Ecowitt API response</p>
  </div>

  <button class="refresh-btn" id="refreshBtn" onclick="manualRefresh()">Refresh Now</button>

  <script>
    // Room display order and grouping
    const ROOM_ORDER = {
      'Outside': { order: 0, floor: 'outdoor' },
      'Hallway (Console)': { order: 1, floor: 'ground' },
      'Hallway': { order: 2, floor: 'ground' },
      'Living Room': { order: 3, floor: 'ground' },
      'Dining Room': { order: 4, floor: 'ground' },
      'Kitchen': { order: 5, floor: 'ground' },
      'Laundry Room': { order: 6, floor: 'ground' },
      'Bedroom 1': { order: 7, floor: 'first' },
      'Bedroom 2': { order: 8, floor: 'first' },
      'Bedroom 4': { order: 9, floor: 'first' }
    };

    function getTemperatureClass(temp) {
      if (temp < 15) return 'temp-cold';
      if (temp < 18) return 'temp-cool';
      if (temp < 22) return 'temp-comfortable';
      if (temp < 25) return 'temp-warm';
      return 'temp-hot';
    }

    function formatTime(date) {
      if (!date) return 'Never';
      const d = new Date(date);
      return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
    }

    function createRoomCard(reading) {
      const tempClass = getTemperatureClass(reading.temperature_c);
      const isOutdoor = reading.channel === 'outdoor';
      const isConsole = reading.channel === 'indoor';

      let cardClass = 'room-card';
      if (isOutdoor) cardClass += ' outdoor';
      if (isConsole) cardClass += ' console';

      let batteryHtml = '';
      if (reading.battery !== null && reading.battery !== undefined) {
        const batteryClass = reading.battery <= 1 ? 'battery low' : 'battery';
        const batteryText = reading.battery <= 1 ? 'Low Battery!' : `Battery: ${reading.battery}`;
        batteryHtml = `<div class="${batteryClass}">${batteryText}</div>`;
      }

      return `
        <div class="${cardClass}">
          <div class="room-name">${reading.room_name}</div>
          <div class="temperature ${tempClass}">
            ${reading.temperature_c.toFixed(1)}<span class="unit">째C</span>
          </div>
          <div class="humidity">${reading.humidity}% humidity</div>
          ${batteryHtml}
        </div>
      `;
    }

    function renderReadings(data) {
      const { readings, stats, lastPoll } = data;

      if (!readings || readings.length === 0) {
        document.getElementById('roomGrid').innerHTML = `
          <div class="no-data">
            <h2>No sensor data available</h2>
            <p>Waiting for sensors to report</p>
          </div>
        `;
        return;
      }

      // Update stats
      if (stats.average !== null) {
        document.getElementById('avgTemp').textContent = `${stats.average}째C`;
      }
      if (stats.warmest) {
        document.getElementById('warmestTemp').textContent = `${stats.warmest.temp}째C`;
        document.getElementById('warmestRoom').textContent = stats.warmest.room;
      }
      if (stats.coldest) {
        document.getElementById('coldestTemp').textContent = `${stats.coldest}째C`;
        document.getElementById('coldestRoom').textContent = stats.coldest.room;
      }

      // Update last poll time
      document.getElementById('lastUpdate').textContent = `Last updated: ${formatTime(lastPoll)}`;

      // Sort readings by room order
      readings.sort((a, b) => {
        const orderA = ROOM_ORDER[a.room_name]?.order ?? 99;
        const orderB = ROOM_ORDER[b.room_name]?.order ?? 99;
        return orderA - orderB;
      });

      // Group by floor
      const outdoor = readings.filter(r => ROOM_ORDER[r.room_name]?.floor === 'outdoor');
      const ground = readings.filter(r => ROOM_ORDER[r.room_name]?.floor === 'ground');
      const first = readings.filter(r => ROOM_ORDER[r.room_name]?.floor === 'first');
      const other = readings.filter(r => !ROOM_ORDER[r.room_name]);

      let html = '';

      if (outdoor.length > 0) {
        html += `
          <div class="floor-section">
            <div class="floor-title">Outside</div>
            <div class="grid">${outdoor.map(createRoomCard).join('')}</div>
          </div>
        `;
      }

      if (ground.length > 0) {
        html += `
          <div class="floor-section">
            <div class="floor-title">Ground Floor</div>
            <div class="grid">${ground.map(createRoomCard).join('')}</div>
          </div>
        `;
      }

      if (first.length > 0) {
        html += `
          <div class="floor-section">
            <div class="floor-title">First Floor</div>
            <div class="grid">${first.map(createRoomCard).join('')}</div>
          </div>
        `;
      }

      if (other.length > 0) {
        html += `
          <div class="floor-section">
            <div class="floor-title">Other Sensors</div>
            <div class="grid">${other.map(createRoomCard).join('')}</div>
          </div>
        `;
      }

      document.getElementById('roomGrid').innerHTML = html;
    }

    async function fetchData() {
      try {
        const response = await fetch('/api/current');
        const data = await response.json();
        renderReadings(data);
      } catch (error) {
        console.error('Error fetching data:', error);
        document.getElementById('lastUpdate').textContent = 'Error loading data';
      }
    }

    async function manualRefresh() {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.textContent = 'Refreshing...';

      try {
        const response = await fetch('/api/poll');
        const data = await response.json();
        if (data.success) {
          await fetchData();
        }
      } catch (error) {
        console.error('Error refreshing:', error);
      }

      btn.disabled = false;
      btn.textContent = 'Refresh Now';
    }

    // Initial load
    fetchData();

    // Auto-refresh every 30 seconds
    setInterval(fetchData, 30000);
  </script>
</body>
</html>
