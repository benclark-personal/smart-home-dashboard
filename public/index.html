<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Home Temperature Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    .header h1 {
      font-size: 1.8rem;
      font-weight: 300;
      margin-bottom: 8px;
    }

    .header .last-update {
      font-size: 0.85rem;
      color: #888;
    }

    .header .clock {
      font-size: 2.5rem;
      font-weight: 300;
      color: #4fc3f7;
      margin-bottom: 5px;
    }

    /* Tab navigation */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #888;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .tab-btn.active {
      background: rgba(79, 195, 247, 0.2);
      border-color: rgba(79, 195, 247, 0.4);
      color: #4fc3f7;
    }

    .tab-content {
      display: none;
      max-width: 1400px;
      margin: 0 auto;
    }

    .tab-content.active {
      display: block;
    }

    /* Stats bar */
    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .stat {
      text-align: center;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      min-width: 130px;
    }

    .stat-label {
      font-size: 0.75rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 1.6rem;
      font-weight: 600;
    }

    .stat-room {
      font-size: 0.75rem;
      color: #666;
      margin-top: 2px;
    }

    .stat.average .stat-value { color: #4fc3f7; }
    .stat.warmest .stat-value { color: #ff7043; }
    .stat.coldest .stat-value { color: #29b6f6; }
    .stat.outside .stat-value { color: #81c784; }
    .stat.heating .stat-value { color: #888; }
    .stat.heating.on .stat-value { color: #ff9800; }
    .stat.heating.off .stat-value { color: #666; }

    /* Room cards grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
    }

    .room-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 15px;
      transition: transform 0.2s, background 0.2s;
    }

    .room-card:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.12);
    }

    .room-card.outdoor {
      background: rgba(100, 181, 246, 0.15);
      border: 1px solid rgba(100, 181, 246, 0.3);
    }

    .room-card.console {
      background: rgba(255, 193, 7, 0.15);
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .room-name {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 10px;
      color: #ccc;
    }

    .temperature {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .temperature .unit {
      font-size: 1rem;
      font-weight: 400;
      color: #888;
    }

    .humidity {
      font-size: 0.9rem;
      color: #64b5f6;
    }

    .battery {
      font-size: 0.75rem;
      color: #888;
      margin-top: 8px;
    }

    .battery.low {
      color: #ff5252;
    }

    .floor-section {
      margin-bottom: 25px;
    }

    .floor-title {
      font-size: 1rem;
      font-weight: 500;
      color: #666;
      margin-bottom: 12px;
      padding-left: 5px;
      border-left: 3px solid #4fc3f7;
    }

    /* Chart container */
    .chart-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .chart-legend {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      padding: 4px 0;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: #ccc;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .chart-title {
      font-size: 1rem;
      font-weight: 500;
      color: #ccc;
    }

    .chart-controls {
      display: flex;
      gap: 8px;
    }

    .chart-controls select, .chart-controls button {
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      color: #fff;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .chart-controls select:hover, .chart-controls button:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    /* Multi-select dropdown */
    .multi-select {
      position: relative;
      display: inline-block;
    }

    .multi-select-btn {
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      color: #fff;
      font-size: 0.8rem;
      cursor: pointer;
      min-width: 120px;
      text-align: left;
    }

    .multi-select-btn:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .multi-select-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: #1a1a2e;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: 8px 0;
      min-width: 160px;
      z-index: 100;
      max-height: 250px;
      overflow-y: auto;
    }

    .multi-select-dropdown.show {
      display: block;
    }

    .multi-select-item {
      display: flex;
      align-items: center;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.8rem;
      color: #ccc;
    }

    .multi-select-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .multi-select-item input {
      margin-right: 8px;
      accent-color: #4fc3f7;
    }

    .multi-select-item.select-all {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 4px;
      padding-bottom: 10px;
    }

    /* Analysis tables */
    .analysis-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .analysis-table th, .analysis-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .analysis-table th {
      background: rgba(255, 255, 255, 0.05);
      color: #888;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .analysis-table td {
      font-size: 0.9rem;
    }

    .analysis-table tr:last-child td {
      border-bottom: none;
    }

    .rate-positive { color: #ff7043; }
    .rate-negative { color: #29b6f6; }
    .rate-neutral { color: #888; }

    .diff-positive { color: #ff7043; }
    .diff-negative { color: #29b6f6; }
    .diff-neutral { color: #81c784; }

    /* Info cards */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .info-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
    }

    .info-card h3 {
      font-size: 0.75rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .info-card .value {
      font-size: 1.4rem;
      font-weight: 600;
      color: #4fc3f7;
    }

    .info-card .detail {
      font-size: 0.8rem;
      color: #666;
      margin-top: 4px;
    }

    /* Export button */
    .export-btn {
      display: inline-block;
      padding: 10px 20px;
      background: rgba(129, 199, 132, 0.2);
      border: 1px solid rgba(129, 199, 132, 0.4);
      border-radius: 8px;
      color: #81c784;
      text-decoration: none;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .export-btn:hover {
      background: rgba(129, 199, 132, 0.3);
    }

    /* Refresh button */
    .refresh-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      background: rgba(79, 195, 247, 0.2);
      border: 1px solid rgba(79, 195, 247, 0.4);
      border-radius: 8px;
      color: #4fc3f7;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.2s;
    }

    .refresh-btn:hover {
      background: rgba(79, 195, 247, 0.3);
    }

    .refresh-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Temperature colours */
    .temp-cold { color: #29b6f6; }
    .temp-cool { color: #4fc3f7; }
    .temp-comfortable { color: #81c784; }
    .temp-warm { color: #ffb74d; }
    .temp-hot { color: #ff7043; }

    .no-data {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    @media (max-width: 768px) {
      .stats-bar { gap: 10px; }
      .stat { min-width: 80px; padding: 10px 12px; }
      .stat-value { font-size: 1.3rem; }
      .grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .room-card { padding: 12px; }
      .temperature { font-size: 1.8rem; }
      .tabs { gap: 5px; }
      .tab-btn { padding: 8px 12px; font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="clock" id="clock">--:--</div>
    <h1>Smart Home Temperature</h1>
    <div class="last-update" id="lastUpdate">Loading...</div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('current')">Current</button>
    <button class="tab-btn" onclick="showTab('history')">History</button>
    <button class="tab-btn" onclick="showTab('analysis')">Analysis</button>
    <button class="tab-btn" onclick="showTab('energy')">Energy</button>
    <button class="tab-btn" onclick="showTab('water')">Water</button>
    <button class="tab-btn" onclick="showTab('data')">Data</button>
  </div>

  <!-- Current Tab -->
  <div id="tab-current" class="tab-content active">
    <div class="stats-bar" id="statsBar">
      <div class="stat outside">
        <div class="stat-label">Outside</div>
        <div class="stat-value" id="outsideTemp">--</div>
      </div>
      <div class="stat average">
        <div class="stat-label">House Avg</div>
        <div class="stat-value" id="avgTemp">--</div>
      </div>
      <div class="stat warmest">
        <div class="stat-label">Warmest</div>
        <div class="stat-value" id="warmestTemp">--</div>
        <div class="stat-room" id="warmestRoom">--</div>
      </div>
      <div class="stat coldest">
        <div class="stat-label">Coldest</div>
        <div class="stat-value" id="coldestTemp">--</div>
        <div class="stat-room" id="coldestRoom">--</div>
      </div>
      <div class="stat heating" id="heatingStatus">
        <div class="stat-label">Heating</div>
        <div class="stat-value" id="heatingValue">--</div>
      </div>
    </div>

    <div id="roomGrid" class="no-data">
      <h2>Loading sensor data...</h2>
    </div>
  </div>

  <!-- History Tab -->
  <div id="tab-history" class="tab-content">
    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">Indoor Temperature History</span>
        <div class="chart-controls">
          <div class="multi-select" id="roomFilterContainer">
            <button class="multi-select-btn" onclick="toggleRoomFilter(event)">All Rooms ▾</button>
            <div class="multi-select-dropdown" id="roomFilterDropdown">
              <label class="multi-select-item select-all">
                <input type="checkbox" id="roomSelectAll" checked onchange="toggleAllRooms(this.checked)"> All Rooms
              </label>
              <label class="multi-select-item"><input type="checkbox" value="Entrance Hall" checked onchange="updateRoomFilter()"> Entrance Hall</label>
              <label class="multi-select-item"><input type="checkbox" value="Living Room" checked onchange="updateRoomFilter()"> Living Room</label>
              <label class="multi-select-item"><input type="checkbox" value="Dining Room (Console)" checked onchange="updateRoomFilter()"> Dining Room</label>
              <label class="multi-select-item"><input type="checkbox" value="Laundry" checked onchange="updateRoomFilter()"> Laundry</label>
              <label class="multi-select-item"><input type="checkbox" value="Master Bedroom" checked onchange="updateRoomFilter()"> Master Bedroom</label>
              <label class="multi-select-item"><input type="checkbox" value="Layla Room" checked onchange="updateRoomFilter()"> Layla Room</label>
            </div>
          </div>
          <select id="historyHours" onchange="loadHistory()">
            <option value="0.167">10 mins</option>
            <option value="0.5">30 mins</option>
            <option value="1">1 hour</option>
            <option value="2">2 hours</option>
            <option value="3">3 hours</option>
            <option value="4">4 hours</option>
            <option value="5">5 hours</option>
            <option value="6">6 hours</option>
            <option value="12">12 hours</option>
            <option value="24" selected>24 hours</option>
            <option value="48">48 hours</option>
            <option value="168">7 days</option>
          </select>
        </div>
      </div>
      <div class="chart-legend" id="tempLegendTop"></div>
      <div style="height: 700px;"><canvas id="tempChart"></canvas></div>
      <div class="chart-legend" id="tempLegendBottom"></div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">Outdoor Temperature History</span>
      </div>
      <div style="height: 200px;"><canvas id="outdoorTempChart"></canvas></div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">Indoor Humidity History</span>
      </div>
      <div class="chart-legend" id="humidityLegendTop"></div>
      <div style="height: 700px;"><canvas id="humidityChart"></canvas></div>
      <div class="chart-legend" id="humidityLegendBottom"></div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">Outdoor Humidity History</span>
      </div>
      <div style="height: 200px;"><canvas id="outdoorHumidityChart"></canvas></div>
    </div>
  </div>

  <!-- Analysis Tab -->
  <div id="tab-analysis" class="tab-content">
    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">Temperature Differentials (vs Entrance Hall)</span>
      </div>
      <div id="differentialsTable"></div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">Heat-up / Cool-down Rates (last 24h)</span>
      </div>
      <div id="ratesTable"></div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">Daily Statistics (last 7 days)</span>
      </div>
      <div id="dailyStatsTable"></div>
    </div>
  </div>

  <!-- Data Tab -->
  <div id="tab-data" class="tab-content">
    <div class="info-grid" id="dbInfo">
      <div class="info-card">
        <h3>Total Readings</h3>
        <div class="value" id="totalReadings">--</div>
      </div>
      <div class="info-card">
        <h3>Active Sensors</h3>
        <div class="value" id="sensorCount">--</div>
      </div>
      <div class="info-card">
        <h3>Days of Data</h3>
        <div class="value" id="daysOfData">--</div>
      </div>
      <div class="info-card">
        <h3>First Reading</h3>
        <div class="value" id="firstReading">--</div>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">Export Data</span>
      </div>
      <p style="color: #888; margin-bottom: 15px;">Download temperature data as CSV for analysis in Excel or other tools.</p>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <a href="/api/export/csv?hours=24" class="export-btn">Last 24 Hours</a>
        <a href="/api/export/csv?hours=168" class="export-btn">Last 7 Days</a>
        <a href="/api/export/csv?hours=720" class="export-btn">Last 30 Days</a>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">API Endpoints</span>
      </div>
      <div style="font-family: monospace; font-size: 0.85rem; color: #888;">
        <p style="margin-bottom: 8px;"><strong style="color: #4fc3f7;">GET</strong> /api/current - Current readings</p>
        <p style="margin-bottom: 8px;"><strong style="color: #4fc3f7;">GET</strong> /api/history?hours=24 - Historical data</p>
        <p style="margin-bottom: 8px;"><strong style="color: #4fc3f7;">GET</strong> /api/stats/daily?days=7 - Daily statistics</p>
        <p style="margin-bottom: 8px;"><strong style="color: #4fc3f7;">GET</strong> /api/stats/rates?hours=24 - Heat/cool rates</p>
        <p style="margin-bottom: 8px;"><strong style="color: #4fc3f7;">GET</strong> /api/stats/differentials - Room differentials</p>
        <p><strong style="color: #81c784;">GET</strong> /api/export/csv?hours=24 - CSV export</p>
      </div>
    </div>
  </div>

  <!-- Energy Tab -->
  <div id="tab-energy" class="tab-content">
    <div class="stats-bar" id="energyStatsBar">
      <div class="stat" style="border-left: 3px solid #ffc107;">
        <div class="stat-label">Yesterday</div>
        <div class="stat-value" id="energyYesterday" style="color: #ffc107;">--</div>
        <div class="stat-room" id="energyYesterdayBreakdown">--</div>
      </div>
      <div class="stat" style="border-left: 3px solid #4fc3f7;">
        <div class="stat-label">This Week</div>
        <div class="stat-value" id="energyWeek" style="color: #4fc3f7;">--</div>
        <div class="stat-room" id="energyWeekBreakdown">--</div>
      </div>
      <div class="stat" style="border-left: 3px solid #81c784;">
        <div class="stat-label">Avg Daily</div>
        <div class="stat-value" id="energyAvgDaily" style="color: #81c784;">--</div>
        <div class="stat-room">based on last 7 days</div>
      </div>
      <div class="stat" style="border-left: 3px solid #ff7043;">
        <div class="stat-label">Gas Yesterday</div>
        <div class="stat-value" id="gasYesterday" style="color: #ff7043;">--</div>
        <div class="stat-room">kWh</div>
      </div>
      <div class="stat" style="border-left: 3px solid #9575cd;">
        <div class="stat-label">Elec Yesterday</div>
        <div class="stat-value" id="elecYesterday" style="color: #9575cd;">--</div>
        <div class="stat-room">kWh</div>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">Daily Energy Usage</span>
        <div class="chart-controls">
          <select id="energyDays" onchange="loadEnergyData()">
            <option value="30" selected>1 Month</option>
            <option value="90">3 Months</option>
            <option value="180">6 Months</option>
            <option value="365">1 Year</option>
            <option value="9999">Max</option>
          </select>
        </div>
      </div>
      <div id="energyNoData" style="text-align: center; padding: 40px; color: #888; display: none;">
        <p style="font-size: 1.2rem; margin-bottom: 10px;">Awaiting energy data...</p>
        <p>Smart meter data typically takes 24-48 hours to sync after registration.</p>
        <p style="margin-top: 10px;"><button onclick="pollEnergy()" style="padding: 8px 16px; background: rgba(79, 195, 247, 0.2); border: 1px solid rgba(79, 195, 247, 0.4); border-radius: 6px; color: #4fc3f7; cursor: pointer;">Check Now</button></p>
      </div>
      <div style="height: 300px;"><canvas id="dailyEnergyChart"></canvas></div>
      <div class="chart-legend" id="energyLegend" style="margin-top: 10px;">
        <span style="margin-right: 20px;"><span style="display: inline-block; width: 12px; height: 12px; background: #ff7043; border-radius: 2px; margin-right: 5px;"></span>Gas</span>
        <span><span style="display: inline-block; width: 12px; height: 12px; background: #9575cd; border-radius: 2px; margin-right: 5px;"></span>Electricity</span>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">Gas Usage vs Outdoor Temperature</span>
      </div>
      <p style="color: #666; font-size: 0.85rem; margin-bottom: 10px;">Colder days should use more gas. Points clustering top-left indicates good correlation.</p>
      <div style="height: 300px;"><canvas id="efficiencyScatter"></canvas></div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title" id="halfHourlyGasTitle">Half-Hourly Gas Usage</span>
      </div>
      <p style="color: #666; font-size: 0.85rem; margin-bottom: 10px;">Orange shading shows heating schedule. Spikes outside heating hours may indicate hot water or cooking.</p>
      <div style="height: 250px;"><canvas id="halfHourlyGasChart"></canvas></div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title" id="halfHourlyElecTitle">Half-Hourly Electricity Usage</span>
      </div>
      <p style="color: #666; font-size: 0.85rem; margin-bottom: 10px;">Identify high-consumption appliances (tumble dryer, oven, etc) by time of use.</p>
      <div style="height: 250px;"><canvas id="halfHourlyElecChart"></canvas></div>
    </div>
  </div>

  <!-- Water Tab -->
  <div id="tab-water" class="tab-content">
    <div class="stats-bar" id="waterStatsBar">
      <div class="stat" style="border-left: 3px solid #2196f3;">
        <div class="stat-label">Yesterday</div>
        <div class="stat-value" id="waterYesterday" style="color: #2196f3;">--</div>
        <div class="stat-room">litres</div>
      </div>
      <div class="stat" style="border-left: 3px solid #03a9f4;">
        <div class="stat-label">7-Day Avg</div>
        <div class="stat-value" id="waterAvg" style="color: #03a9f4;">--</div>
        <div class="stat-room">litres/day</div>
      </div>
      <div class="stat" style="border-left: 3px solid #00bcd4;">
        <div class="stat-label">This Week</div>
        <div class="stat-value" id="waterWeek" style="color: #00bcd4;">--</div>
        <div class="stat-room">litres</div>
      </div>
      <div class="stat" style="border-left: 3px solid #009688;">
        <div class="stat-label">This Month</div>
        <div class="stat-value" id="waterMonth" style="color: #009688;">--</div>
        <div class="stat-room">litres</div>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">Daily Water Usage</span>
        <div class="chart-controls">
          <select id="waterDays" onchange="loadWaterData()">
            <option value="7">1 Week</option>
            <option value="30" selected>1 Month</option>
            <option value="90">3 Months</option>
            <option value="365">1 Year</option>
          </select>
        </div>
      </div>
      <div id="waterNoData" style="text-align: center; padding: 40px; color: #888; display: none;">
        <p style="font-size: 1.2rem; margin-bottom: 10px;">Awaiting water data...</p>
        <p>Severn Trent smart meter data typically has a 24-48 hour delay.</p>
        <p style="margin-top: 10px;"><button onclick="pollWater()" style="padding: 8px 16px; background: rgba(33, 150, 243, 0.2); border: 1px solid rgba(33, 150, 243, 0.4); border-radius: 6px; color: #2196f3; cursor: pointer;">Check Now</button></p>
      </div>
      <div style="height: 300px;"><canvas id="waterChart"></canvas></div>
      <div class="chart-legend" id="waterLegend" style="margin-top: 10px; text-align: center;">
        <span><span style="display: inline-block; width: 12px; height: 12px; background: rgba(33, 150, 243, 0.7); border-radius: 2px; margin-right: 5px;"></span>Daily Usage (litres)</span>
        <span style="margin-left: 20px; color: #888; font-size: 0.85rem;">Meter: 16MA207763</span>
      </div>
    </div>

    <div class="chart-container" style="background: rgba(33, 150, 243, 0.05);">
      <div class="chart-header">
        <span class="chart-title">Water Usage Reference</span>
      </div>
      <p style="color: #888; font-size: 0.85rem; margin-bottom: 15px;">Typical daily water usage for a 2-person household: 250-300 litres</p>
      <table style="width: 100%; color: #ccc; font-size: 0.85rem; border-collapse: collapse;">
        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
          <td style="padding: 8px 0;">Shower (5 mins)</td>
          <td style="text-align: right;">~40 litres</td>
        </tr>
        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
          <td style="padding: 8px 0;">Bath</td>
          <td style="text-align: right;">~80 litres</td>
        </tr>
        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
          <td style="padding: 8px 0;">Toilet flush</td>
          <td style="text-align: right;">~6-9 litres</td>
        </tr>
        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
          <td style="padding: 8px 0;">Washing machine</td>
          <td style="text-align: right;">~50-65 litres</td>
        </tr>
        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
          <td style="padding: 8px 0;">Dishwasher</td>
          <td style="text-align: right;">~10-20 litres</td>
        </tr>
        <tr>
          <td style="padding: 8px 0;">Garden hose (10 mins)</td>
          <td style="text-align: right;">~150 litres</td>
        </tr>
      </table>
    </div>
  </div>

  <button class="refresh-btn" id="refreshBtn" onclick="manualRefresh()">Refresh</button>

  <script>
    // Room display order and grouping
    const ROOM_ORDER = {
      'Outside': { order: 0, floor: 'outdoor' },
      'Entrance Hall': { order: 1, floor: 'ground' },
      'Living Room': { order: 2, floor: 'ground' },
      'Dining Room (Console)': { order: 3, floor: 'ground' },
      'Laundry': { order: 4, floor: 'ground' },
      'Master Bedroom': { order: 5, floor: 'first' },
      'Layla Room': { order: 6, floor: 'first' }
    };

    // Chart colours per room
    const ROOM_COLOURS = {
      'Outside': '#81c784',
      'Entrance Hall': '#4fc3f7',
      'Living Room': '#ff7043',
      'Dining Room (Console)': '#ffc107',
      'Laundry': '#9575cd',
      'Master Bedroom': '#f06292',
      'Layla Room': '#4db6ac'
    };

    // Heating schedule (24h format)
    const HEATING_SCHEDULE = [
      { start: '06:50', end: '09:30' },
      { start: '13:00', end: '14:00' },  // Manual test 25/12/2024
      { start: '15:30', end: '22:00' },
      { start: '22:30', end: '23:59' }   // Late recovery 25/12/2024 (continues to 00:30)
    ];

    // Check if heating is currently on
    function isHeatingOn() {
      const now = new Date();
      const currentMinutes = now.getHours() * 60 + now.getMinutes();
      return HEATING_SCHEDULE.some(period => {
        const [startH, startM] = period.start.split(':').map(Number);
        const [endH, endM] = period.end.split(':').map(Number);
        const startMinutes = startH * 60 + startM;
        const endMinutes = endH * 60 + endM;
        return currentMinutes >= startMinutes && currentMinutes <= endMinutes;
      });
    }

    // Get heating periods within a time range for chart background
    function getHeatingPeriods(minTime, maxTime) {
      const periods = [];
      const startDate = new Date(minTime);
      const endDate = new Date(maxTime);

      // Iterate through each day in the range
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dayStart = new Date(d);
        dayStart.setHours(0, 0, 0, 0);

        HEATING_SCHEDULE.forEach(period => {
          const [startH, startM] = period.start.split(':').map(Number);
          const [endH, endM] = period.end.split(':').map(Number);

          const periodStart = new Date(dayStart);
          periodStart.setHours(startH, startM, 0, 0);

          const periodEnd = new Date(dayStart);
          periodEnd.setHours(endH, endM, 0, 0);

          // Only include if period overlaps with our time range
          if (periodEnd >= minTime && periodStart <= maxTime) {
            periods.push({
              start: Math.max(periodStart.getTime(), minTime),
              end: Math.min(periodEnd.getTime(), maxTime)
            });
          }
        });
      }
      return periods;
    }

    // Chart.js plugin for heating background
    const heatingBackgroundPlugin = {
      id: 'heatingBackground',
      beforeDraw: (chart) => {
        const { ctx, chartArea, scales } = chart;
        if (!chartArea || !chart.options.heatingPeriods) return;

        ctx.save();
        ctx.fillStyle = 'rgba(255, 152, 0, 0.1)';

        chart.options.heatingPeriods.forEach(period => {
          const xStart = scales.x.getPixelForValue(period.start);
          const xEnd = scales.x.getPixelForValue(period.end);
          ctx.fillRect(xStart, chartArea.top, xEnd - xStart, chartArea.bottom - chartArea.top);
        });

        ctx.restore();
      }
    };

    Chart.register(heatingBackgroundPlugin);

    let tempChart = null;
    let humidityChart = null;
    let outdoorTempChart = null;
    let outdoorHumidityChart = null;
    let historyData = null;  // Store history data for filtering

    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).classList.add('active');
      event.target.classList.add('active');

      if (tabName === 'history') loadHistory();
      if (tabName === 'analysis') loadAnalysis();
      if (tabName === 'data') loadDbInfo();
      if (tabName === 'energy') loadEnergyData();
      if (tabName === 'water') loadWaterData();
    }

    function getTemperatureClass(temp) {
      if (temp < 15) return 'temp-cold';
      if (temp < 18) return 'temp-cool';
      if (temp < 22) return 'temp-comfortable';
      if (temp < 25) return 'temp-warm';
      return 'temp-hot';
    }

    function formatTime(date) {
      if (!date) return 'Never';
      const d = new Date(date);
      return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(date) {
      if (!date) return '--';
      const d = new Date(date);
      return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function createRoomCard(reading) {
      const tempClass = getTemperatureClass(reading.temperature_c);
      const isOutdoor = reading.channel === 'outdoor';
      const isConsole = reading.channel === 'indoor';

      let cardClass = 'room-card';
      if (isOutdoor) cardClass += ' outdoor';
      if (isConsole) cardClass += ' console';

      let batteryHtml = '';
      if (reading.battery !== null && reading.battery !== undefined) {
        if (reading.battery >= 1) {
          batteryHtml = `<div class="battery low">Low Battery!</div>`;
        }
      }

      return `
        <div class="${cardClass}">
          <div class="room-name">${reading.room_name}</div>
          <div class="temperature ${tempClass}">
            ${reading.temperature_c.toFixed(1)}<span class="unit">°C</span>
          </div>
          <div class="humidity">${reading.humidity}% humidity</div>
          ${batteryHtml}
        </div>
      `;
    }

    function renderReadings(data) {
      const { readings, stats, lastPoll } = data;

      if (!readings || readings.length === 0) {
        document.getElementById('roomGrid').innerHTML = '<div class="no-data"><h2>No sensor data available</h2></div>';
        return;
      }

      // Update outside temp
      const outside = readings.find(r => r.channel === 'outdoor');
      if (outside) {
        document.getElementById('outsideTemp').textContent = `${outside.temperature_c}°C`;
      }

      // Update stats
      if (stats.average !== null) {
        document.getElementById('avgTemp').textContent = `${stats.average}°C`;
      }
      if (stats.warmest) {
        document.getElementById('warmestTemp').textContent = `${stats.warmest.temp}°C`;
        document.getElementById('warmestRoom').textContent = stats.warmest.room;
      }
      if (stats.coldest) {
        document.getElementById('coldestTemp').textContent = `${stats.coldest.temp}°C`;
        document.getElementById('coldestRoom').textContent = stats.coldest.room;
      }

      // Update heating status
      const heatingOn = isHeatingOn();
      const heatingStatus = document.getElementById('heatingStatus');
      const heatingValue = document.getElementById('heatingValue');
      heatingStatus.className = 'stat heating ' + (heatingOn ? 'on' : 'off');
      heatingValue.textContent = heatingOn ? 'ON' : 'OFF';

      document.getElementById('lastUpdate').textContent = `Last updated: ${formatTime(lastPoll)}`;

      // Sort and group readings
      readings.sort((a, b) => (ROOM_ORDER[a.room_name]?.order ?? 99) - (ROOM_ORDER[b.room_name]?.order ?? 99));

      const outdoor = readings.filter(r => ROOM_ORDER[r.room_name]?.floor === 'outdoor');
      const ground = readings.filter(r => ROOM_ORDER[r.room_name]?.floor === 'ground');
      const first = readings.filter(r => ROOM_ORDER[r.room_name]?.floor === 'first');
      const other = readings.filter(r => !ROOM_ORDER[r.room_name]);

      let html = '';
      if (outdoor.length > 0) {
        html += `<div class="floor-section"><div class="floor-title">Outside</div><div class="grid">${outdoor.map(createRoomCard).join('')}</div></div>`;
      }
      if (ground.length > 0) {
        html += `<div class="floor-section"><div class="floor-title">Ground Floor</div><div class="grid">${ground.map(createRoomCard).join('')}</div></div>`;
      }
      if (first.length > 0) {
        html += `<div class="floor-section"><div class="floor-title">First Floor</div><div class="grid">${first.map(createRoomCard).join('')}</div></div>`;
      }
      if (other.length > 0) {
        html += `<div class="floor-section"><div class="floor-title">Other</div><div class="grid">${other.map(createRoomCard).join('')}</div></div>`;
      }

      document.getElementById('roomGrid').innerHTML = html;
    }

    async function loadHistory() {
      const hours = parseFloat(document.getElementById('historyHours').value);
      try {
        const response = await fetch(`/api/history?hours=${hours}`);
        historyData = await response.json();
        const selectedRooms = getSelectedRooms();
        renderCharts(historyData, hours, selectedRooms);
      } catch (error) {
        console.error('Error loading history:', error);
      }
    }

    function toggleRoomFilter(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('roomFilterDropdown');
      dropdown.classList.toggle('show');
    }

    function toggleAllRooms(checked) {
      const checkboxes = document.querySelectorAll('#roomFilterDropdown input[type="checkbox"]:not(#roomSelectAll)');
      checkboxes.forEach(cb => cb.checked = checked);
      updateRoomFilter();
    }

    function getSelectedRooms() {
      const checkboxes = document.querySelectorAll('#roomFilterDropdown input[type="checkbox"]:not(#roomSelectAll):checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    function updateRoomFilter() {
      const selectedRooms = getSelectedRooms();
      const allCheckbox = document.getElementById('roomSelectAll');
      const totalRooms = document.querySelectorAll('#roomFilterDropdown input[type="checkbox"]:not(#roomSelectAll)').length;

      // Update "All" checkbox state
      allCheckbox.checked = selectedRooms.length === totalRooms;

      // Update button text
      const btn = document.querySelector('#roomFilterContainer .multi-select-btn');
      if (selectedRooms.length === 0) {
        btn.textContent = 'No Rooms ▾';
      } else if (selectedRooms.length === totalRooms) {
        btn.textContent = 'All Rooms ▾';
      } else if (selectedRooms.length === 1) {
        btn.textContent = selectedRooms[0].replace(' (Console)', '') + ' ▾';
      } else {
        btn.textContent = selectedRooms.length + ' Rooms ▾';
      }

      // Re-render charts
      if (historyData) {
        const hours = parseFloat(document.getElementById('historyHours').value);
        renderCharts(historyData, hours, selectedRooms);
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const container = document.getElementById('roomFilterContainer');
      if (container && !container.contains(e.target)) {
        document.getElementById('roomFilterDropdown').classList.remove('show');
      }
    });

    function createLegendHtml(rooms) {
      return rooms.map(room =>
        `<div class="legend-item"><span class="legend-dot" style="background: ${ROOM_COLOURS[room] || '#888'}"></span>${room}</div>`
      ).join('');
    }

    function renderCharts(data, hours = 24, selectedRooms = null) {
      // Group by room
      const byRoom = {};
      for (const row of data) {
        if (!byRoom[row.room_name]) byRoom[row.room_name] = [];
        byRoom[row.room_name].push({ x: new Date(row.timestamp), y: row.temperature_c, humidity: row.humidity });
      }

      // Split indoor and outdoor, apply room filter
      let indoorRooms = Object.keys(byRoom).filter(r => r !== 'Outside');
      if (selectedRooms && selectedRooms.length > 0) {
        indoorRooms = indoorRooms.filter(r => selectedRooms.includes(r));
      }
      const outdoorData = byRoom['Outside'] || [];
      const indoorLegendHtml = createLegendHtml(indoorRooms);

      // Set time range based on selected period (not data)
      const maxTime = Date.now();
      const minTime = maxTime - (hours * 60 * 60 * 1000);

      // Determine time unit and format based on selected period
      let timeUnit, timeFormat, maxTicks;
      if (hours <= 1) {
        timeUnit = 'minute';
        timeFormat = 'HH:mm';
        maxTicks = 12;
      } else if (hours <= 6) {
        timeUnit = 'minute';
        timeFormat = 'HH:mm';
        maxTicks = 12;
      } else if (hours <= 48) {
        timeUnit = 'hour';
        timeFormat = 'HH:mm';
        maxTicks = 12;
      } else {
        timeUnit = 'day';
        timeFormat = 'dd/MM HH:mm';
        maxTicks = 7;
      }

      // Get heating periods for chart background
      const heatingPeriods = getHeatingPeriods(minTime, maxTime);

      // Indoor Temperature chart
      const indoorTempDatasets = indoorRooms.map(room => ({
        label: room,
        data: byRoom[room].map(r => ({ x: r.x, y: r.y })),
        borderColor: ROOM_COLOURS[room] || '#888',
        backgroundColor: 'transparent',
        tension: 0.3,
        pointRadius: 0,
        borderWidth: 2
      }));

      document.getElementById('tempLegendTop').innerHTML = indoorLegendHtml;
      document.getElementById('tempLegendBottom').innerHTML = indoorLegendHtml;

      const tempCtx = document.getElementById('tempChart').getContext('2d');
      if (tempChart) tempChart.destroy();
      tempChart = new Chart(tempCtx, {
        type: 'line',
        data: { datasets: indoorTempDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          heatingPeriods: heatingPeriods,
          scales: {
            x: { position: 'top', type: 'time', min: minTime, max: maxTime, time: { unit: timeUnit, displayFormats: { minute: timeFormat, hour: timeFormat, day: timeFormat } }, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888', maxTicksLimit: maxTicks } },
            xBottom: { position: 'bottom', type: 'time', min: minTime, max: maxTime, time: { unit: timeUnit, displayFormats: { minute: timeFormat, hour: timeFormat, day: timeFormat } }, grid: { drawOnChartArea: false }, ticks: { color: '#888', maxTicksLimit: maxTicks } },
            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888', callback: v => v + '°C', maxTicksLimit: 6 } }
          },
          plugins: { legend: { display: false } }
        }
      });

      // Outdoor Temperature chart
      const outdoorTempCtx = document.getElementById('outdoorTempChart').getContext('2d');
      if (outdoorTempChart) outdoorTempChart.destroy();
      outdoorTempChart = new Chart(outdoorTempCtx, {
        type: 'line',
        data: { datasets: [{
          label: 'Outside',
          data: outdoorData.map(r => ({ x: r.x, y: r.y })),
          borderColor: ROOM_COLOURS['Outside'],
          backgroundColor: 'transparent',
          tension: 0.3,
          pointRadius: 0,
          borderWidth: 2
        }]},
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { position: 'top', type: 'time', min: minTime, max: maxTime, time: { unit: timeUnit, displayFormats: { minute: timeFormat, hour: timeFormat, day: timeFormat } }, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888', maxTicksLimit: maxTicks } },
            xBottom: { position: 'bottom', type: 'time', min: minTime, max: maxTime, time: { unit: timeUnit, displayFormats: { minute: timeFormat, hour: timeFormat, day: timeFormat } }, grid: { drawOnChartArea: false }, ticks: { color: '#888', maxTicksLimit: maxTicks } },
            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888', callback: v => v.toFixed(1) + '°C' } }
          },
          plugins: { legend: { display: false } }
        }
      });

      // Indoor Humidity chart
      const indoorHumidityDatasets = indoorRooms.map(room => ({
        label: room,
        data: byRoom[room].map(r => ({ x: r.x, y: r.humidity })),
        borderColor: ROOM_COLOURS[room] || '#888',
        backgroundColor: 'transparent',
        tension: 0.3,
        pointRadius: 0,
        borderWidth: 1.5
      }));

      document.getElementById('humidityLegendTop').innerHTML = indoorLegendHtml;
      document.getElementById('humidityLegendBottom').innerHTML = indoorLegendHtml;

      const humCtx = document.getElementById('humidityChart').getContext('2d');
      if (humidityChart) humidityChart.destroy();
      humidityChart = new Chart(humCtx, {
        type: 'line',
        data: { datasets: indoorHumidityDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          heatingPeriods: heatingPeriods,
          scales: {
            x: { position: 'top', type: 'time', min: minTime, max: maxTime, time: { unit: timeUnit, displayFormats: { minute: timeFormat, hour: timeFormat, day: timeFormat } }, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888', maxTicksLimit: maxTicks } },
            xBottom: { position: 'bottom', type: 'time', min: minTime, max: maxTime, time: { unit: timeUnit, displayFormats: { minute: timeFormat, hour: timeFormat, day: timeFormat } }, grid: { drawOnChartArea: false }, ticks: { color: '#888', maxTicksLimit: maxTicks } },
            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888', callback: v => v + '%', maxTicksLimit: 5 } }
          },
          plugins: { legend: { display: false } }
        }
      });

      // Outdoor Humidity chart
      const outdoorHumCtx = document.getElementById('outdoorHumidityChart').getContext('2d');
      if (outdoorHumidityChart) outdoorHumidityChart.destroy();
      outdoorHumidityChart = new Chart(outdoorHumCtx, {
        type: 'line',
        data: { datasets: [{
          label: 'Outside',
          data: outdoorData.map(r => ({ x: r.x, y: r.humidity })),
          borderColor: ROOM_COLOURS['Outside'],
          backgroundColor: 'transparent',
          tension: 0.3,
          pointRadius: 0,
          borderWidth: 1.5
        }]},
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { position: 'top', type: 'time', min: minTime, max: maxTime, time: { unit: timeUnit, displayFormats: { minute: timeFormat, hour: timeFormat, day: timeFormat } }, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888', maxTicksLimit: maxTicks } },
            xBottom: { position: 'bottom', type: 'time', min: minTime, max: maxTime, time: { unit: timeUnit, displayFormats: { minute: timeFormat, hour: timeFormat, day: timeFormat } }, grid: { drawOnChartArea: false }, ticks: { color: '#888', maxTicksLimit: maxTicks } },
            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888', callback: v => v + '%' } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    async function loadAnalysis() {
      try {
        const [diffRes, ratesRes, dailyRes] = await Promise.all([
          fetch('/api/stats/differentials'),
          fetch('/api/stats/rates'),
          fetch('/api/stats/daily')
        ]);

        const differentials = await diffRes.json();
        const rates = await ratesRes.json();
        const daily = await dailyRes.json();

        renderDifferentials(differentials);
        renderRates(rates);
        renderDailyStats(daily);
      } catch (error) {
        console.error('Error loading analysis:', error);
      }
    }

    function renderDifferentials(data) {
      if (!data.differentials || data.differentials.length === 0) {
        document.getElementById('differentialsTable').innerHTML = '<p class="no-data">No data available</p>';
        return;
      }

      let html = `<p style="color: #888; margin-bottom: 10px; font-size: 0.85rem;">Baseline: ${data.baselineSource} (${data.baseline}°C)</p>`;
      html += '<table class="analysis-table"><thead><tr><th>Room</th><th>Temp</th><th>Differential</th><th>Humidity</th></tr></thead><tbody>';

      for (const d of data.differentials) {
        const diffClass = d.differential > 0.5 ? 'diff-positive' : d.differential < -0.5 ? 'diff-negative' : 'diff-neutral';
        const diffText = d.differential > 0 ? `+${d.differential}°C` : `${d.differential}°C`;
        html += `<tr>
          <td>${d.roomName}</td>
          <td>${d.temperature}°C</td>
          <td class="${diffClass}">${diffText}</td>
          <td>${d.humidity}%</td>
        </tr>`;
      }

      html += '</tbody></table>';
      document.getElementById('differentialsTable').innerHTML = html;
    }

    function renderRates(rates) {
      if (!rates || rates.length === 0) {
        document.getElementById('ratesTable').innerHTML = '<p class="no-data">Not enough data for rate analysis</p>';
        return;
      }

      let html = '<table class="analysis-table"><thead><tr><th>Room</th><th>Heat Rate</th><th>Cool Rate</th><th>Temp Swing</th><th>Min</th><th>Max</th></tr></thead><tbody>';

      for (const r of rates) {
        const heatClass = r.avgHeatRate > 0 ? 'rate-positive' : 'rate-neutral';
        const coolClass = r.avgCoolRate < 0 ? 'rate-negative' : 'rate-neutral';
        html += `<tr>
          <td>${r.roomName}</td>
          <td class="${heatClass}">${r.avgHeatRate > 0 ? '+' : ''}${r.avgHeatRate}°C/h</td>
          <td class="${coolClass}">${r.avgCoolRate}°C/h</td>
          <td>${r.tempSwing}°C</td>
          <td>${r.minTemp}°C</td>
          <td>${r.maxTemp}°C</td>
        </tr>`;
      }

      html += '</tbody></table>';
      document.getElementById('ratesTable').innerHTML = html;
    }

    function renderDailyStats(stats) {
      if (!stats || stats.length === 0) {
        document.getElementById('dailyStatsTable').innerHTML = '<p class="no-data">No daily statistics available</p>';
        return;
      }

      // Group by date
      const byDate = {};
      for (const s of stats) {
        if (!byDate[s.date]) byDate[s.date] = [];
        byDate[s.date].push(s);
      }

      let html = '';
      for (const [date, rooms] of Object.entries(byDate).slice(0, 3)) {
        html += `<h4 style="color: #888; margin: 15px 0 10px; font-size: 0.85rem;">${formatDate(date)}</h4>`;
        html += '<table class="analysis-table"><thead><tr><th>Room</th><th>Min</th><th>Max</th><th>Avg</th><th>Humidity</th></tr></thead><tbody>';

        for (const r of rooms) {
          html += `<tr>
            <td>${r.room_name}</td>
            <td class="temp-cool">${r.min_temp}°C</td>
            <td class="temp-warm">${r.max_temp}°C</td>
            <td>${r.avg_temp}°C</td>
            <td>${r.avg_humidity}%</td>
          </tr>`;
        }
        html += '</tbody></table>';
      }

      document.getElementById('dailyStatsTable').innerHTML = html;
    }

    async function loadDbInfo() {
      try {
        const response = await fetch('/api/info');
        const info = await response.json();

        document.getElementById('totalReadings').textContent = info.total_readings.toLocaleString();
        document.getElementById('sensorCount').textContent = info.sensor_count;
        document.getElementById('daysOfData').textContent = info.days_of_data;
        document.getElementById('firstReading').textContent = formatDate(info.first_reading);
      } catch (error) {
        console.error('Error loading db info:', error);
      }
    }

    async function fetchData() {
      try {
        const response = await fetch('/api/current');
        const data = await response.json();
        renderReadings(data);
      } catch (error) {
        console.error('Error fetching data:', error);
        document.getElementById('lastUpdate').textContent = 'Error loading data';
      }
    }

    async function manualRefresh() {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.textContent = 'Refreshing...';

      try {
        await fetch('/api/poll');
        await fetchData();
        if (document.getElementById('tab-history').classList.contains('active')) loadHistory();
        if (document.getElementById('tab-analysis').classList.contains('active')) loadAnalysis();
      } catch (error) {
        console.error('Error refreshing:', error);
      }

      btn.disabled = false;
      btn.textContent = 'Refresh';
    }

    // Clock update
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
    }

    // Energy chart instances
    let dailyEnergyChart = null;
    let efficiencyScatter = null;
    let halfHourlyGasChart = null;
    let halfHourlyElecChart = null;

    // Load energy data
    async function loadEnergyData() {
      const days = parseInt(document.getElementById('energyDays').value);

      try {
        const [dailyRes, historyRes, currentRes, correlationRes] = await Promise.all([
          fetch(`/api/energy/daily?days=${days}`),
          fetch(`/api/energy/history?days=4`),
          fetch('/api/energy/current'),
          fetch(`/api/energy/correlation?days=${days}`)
        ]);

        const dailyData = await dailyRes.json();
        const historyData = await historyRes.json();
        const currentData = await currentRes.json();
        const correlationData = await correlationRes.json();

        // Check if we have data
        const hasData = dailyData.length > 0 || historyData.length > 0;
        document.getElementById('energyNoData').style.display = hasData ? 'none' : 'block';

        // Update stats
        updateEnergyStats(currentData, dailyData);

        // Render charts
        renderDailyEnergyChart(dailyData);
        renderEfficiencyScatter(correlationData);
        renderHalfHourlyCharts(historyData);

      } catch (error) {
        console.error('Error loading energy data:', error);
        document.getElementById('energyNoData').style.display = 'block';
      }
    }

    function updateEnergyStats(currentData, dailyData) {
      const gasYesterday = currentData.yesterday?.gas || 0;
      const elecYesterday = currentData.yesterday?.electricity || 0;
      const gasWeek = currentData.lastWeek?.gas || 0;
      const elecWeek = currentData.lastWeek?.electricity || 0;

      // Rough cost calculation (adjust rates as needed)
      const gasRate = 6.24; // pence per kWh
      const elecRate = 24.50; // pence per kWh
      const standingGas = 31.43; // pence per day
      const standingElec = 53.35; // pence per day

      const yesterdayCost = (gasYesterday * gasRate + elecYesterday * elecRate + standingGas + standingElec) / 100;
      const weekCost = (gasWeek * gasRate + elecWeek * elecRate + (standingGas + standingElec) * 7) / 100;
      const avgDaily = weekCost / 7;

      document.getElementById('energyYesterday').textContent = gasYesterday > 0 ? `£${yesterdayCost.toFixed(2)}` : '--';
      document.getElementById('energyYesterdayBreakdown').textContent = gasYesterday > 0 ? `Gas: ${gasYesterday.toFixed(1)} + Elec: ${elecYesterday.toFixed(1)} kWh` : '--';

      document.getElementById('energyWeek').textContent = gasWeek > 0 ? `£${weekCost.toFixed(2)}` : '--';
      document.getElementById('energyWeekBreakdown').textContent = gasWeek > 0 ? `Gas: ${gasWeek.toFixed(1)} + Elec: ${elecWeek.toFixed(1)} kWh` : '--';

      document.getElementById('energyAvgDaily').textContent = gasWeek > 0 ? `£${avgDaily.toFixed(2)}` : '--';

      document.getElementById('gasYesterday').textContent = gasYesterday > 0 ? gasYesterday.toFixed(1) : '--';
      document.getElementById('elecYesterday').textContent = elecYesterday > 0 ? elecYesterday.toFixed(1) : '--';
    }

    function renderDailyEnergyChart(dailyData) {
      const ctx = document.getElementById('dailyEnergyChart').getContext('2d');
      const selectedDays = parseInt(document.getElementById('energyDays').value);

      // Group by date
      const byDate = {};
      dailyData.forEach(d => {
        if (!byDate[d.date]) byDate[d.date] = { gas: 0, electricity: 0 };
        byDate[d.date][d.type] = d.total_kwh;
      });

      const dates = Object.keys(byDate).sort();
      const gasData = dates.map(d => byDate[d].gas);
      const elecData = dates.map(d => byDate[d].electricity);

      // Calculate month boundaries and centers for labels
      const monthBoundaries = []; // Indices where month changes
      const monthLabels = []; // { center: index, label: 'Dec' }
      let currentMonth = null;
      let monthStartIdx = 0;

      dates.forEach((d, index) => {
        const date = new Date(d);
        const month = date.toLocaleDateString('en-GB', { month: 'short' });

        if (month !== currentMonth) {
          if (currentMonth !== null) {
            // End of previous month - record boundary and center
            monthBoundaries.push(index);
            const center = Math.floor((monthStartIdx + index - 1) / 2);
            monthLabels.push({ center, label: currentMonth });
          }
          currentMonth = month;
          monthStartIdx = index;
        }

        // Handle last month
        if (index === dates.length - 1) {
          const center = Math.floor((monthStartIdx + index) / 2);
          monthLabels.push({ center, label: currentMonth });
        }
      });

      // Create day-only labels
      const dayLabels = dates.map(d => {
        const date = new Date(d);
        if (selectedDays <= 14) {
          return date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric' });
        }
        return date.getDate().toString();
      });

      // Determine skip interval for day labels based on range
      let skipInterval = 1;
      if (selectedDays > 30) skipInterval = 2;
      if (selectedDays > 60) skipInterval = 4;
      if (selectedDays > 120) skipInterval = 7;
      if (selectedDays > 200) skipInterval = 10;

      if (dailyEnergyChart) dailyEnergyChart.destroy();

      // Custom plugin to draw month labels and dividers
      const monthPlugin = {
        id: 'monthLabels',
        afterDraw: (chart) => {
          const ctx = chart.ctx;
          const xAxis = chart.scales.x;
          const yAxis = chart.scales.y;
          const monthLabelY = xAxis.bottom + 22; // Position for month labels

          // Draw vertical month dividers (extending down to month label area)
          ctx.save();
          ctx.strokeStyle = 'rgba(255,255,255,0.4)';
          ctx.lineWidth = 1;
          ctx.setLineDash([4, 4]);

          monthBoundaries.forEach(idx => {
            const x = xAxis.getPixelForValue(idx) - (xAxis.getPixelForValue(1) - xAxis.getPixelForValue(0)) / 2;
            ctx.beginPath();
            ctx.moveTo(x, yAxis.top);
            ctx.lineTo(x, monthLabelY + 6); // Extend down past month labels
            ctx.stroke();
          });
          ctx.restore();

          // Draw month labels centered below axis
          ctx.save();
          ctx.fillStyle = '#aaa';
          ctx.font = 'bold 11px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'top';

          monthLabels.forEach(({ center, label }) => {
            const x = xAxis.getPixelForValue(center);
            ctx.fillText(label, x, monthLabelY);
          });
          ctx.restore();
        }
      };

      dailyEnergyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dayLabels,
          datasets: [
            {
              label: 'Gas (kWh)',
              data: gasData,
              backgroundColor: 'rgba(255, 112, 67, 0.7)',
              borderColor: '#ff7043',
              borderWidth: 1
            },
            {
              label: 'Electricity (kWh)',
              data: elecData,
              backgroundColor: 'rgba(149, 117, 205, 0.7)',
              borderColor: '#9575cd',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: {
            padding: { bottom: 35 } // Space for month labels
          },
          scales: {
            x: {
              stacked: true,
              grid: { color: 'rgba(255,255,255,0.1)' },
              ticks: {
                color: '#888',
                maxRotation: 0,
                minRotation: 0,
                autoSkip: false,
                callback: function(value, index) {
                  if (index % skipInterval === 0) return dayLabels[index];
                  return '';
                }
              }
            },
            y: { stacked: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888', callback: v => v + ' kWh' } }
          },
          plugins: { legend: { display: false } }
        },
        plugins: [monthPlugin]
      });
    }

    function renderEfficiencyScatter(correlationData) {
      const ctx = document.getElementById('efficiencyScatter').getContext('2d');

      if (efficiencyScatter) efficiencyScatter.destroy();

      const points = (correlationData || []).map(d => ({
        x: d.avg_outdoor_temp,
        y: d.gas_kwh
      })).filter(p => p.x !== null && p.y !== null && p.y > 0);

      efficiencyScatter = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Daily Gas vs Outdoor Temp',
            data: points,
            backgroundColor: 'rgba(255, 112, 67, 0.6)',
            borderColor: '#ff7043',
            pointRadius: 8,
            pointHoverRadius: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: 'Avg Outdoor Temp (°C)', color: '#888' },
              grid: { color: 'rgba(255,255,255,0.1)' },
              ticks: { color: '#888' },
              reverse: true  // Colder on left
            },
            y: {
              title: { display: true, text: 'Gas Usage (kWh)', color: '#888' },
              grid: { color: 'rgba(255,255,255,0.1)' },
              ticks: { color: '#888' }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.parsed.y.toFixed(1)} kWh at ${ctx.parsed.x.toFixed(1)}°C`
              }
            }
          }
        }
      });
    }

    function renderHalfHourlyCharts(historyData) {
      // Find the most recent day with substantial data (at least 12 readings)
      // Smart meter data is delayed, so today may only have partial data
      const dates = [...new Set(historyData.map(d => d.timestamp.slice(0, 10)))].sort().reverse();

      let mostRecentDate = null;
      for (const date of dates) {
        const dayReadings = historyData.filter(d => d.timestamp.startsWith(date));
        if (dayReadings.length >= 12) {
          mostRecentDate = date;
          break;
        }
      }

      // Fall back to most recent if no day has enough data
      if (!mostRecentDate) mostRecentDate = dates[0] || null;

      if (!mostRecentDate) {
        document.getElementById('halfHourlyGasTitle').textContent = 'Half-Hourly Gas Usage (No data)';
        document.getElementById('halfHourlyElecTitle').textContent = 'Half-Hourly Electricity Usage (No data)';
        return;
      }

      // Format date for display
      const displayDate = new Date(mostRecentDate + 'T00:00:00');
      const dateLabel = displayDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
      document.getElementById('halfHourlyGasTitle').textContent = `Half-Hourly Gas Usage (${dateLabel})`;
      document.getElementById('halfHourlyElecTitle').textContent = `Half-Hourly Electricity Usage (${dateLabel})`;

      const dayData = historyData.filter(d => d.timestamp.startsWith(mostRecentDate));

      // Create lookup maps for existing data
      const gasMap = {};
      const elecMap = {};
      dayData.forEach(d => {
        const timeKey = d.timestamp.slice(11, 16); // "HH:MM"
        if (d.type === 'gas') gasMap[timeKey] = d.kwh;
        if (d.type === 'electricity') elecMap[timeKey] = d.kwh;
      });

      // Generate all 48 half-hour labels and fill data (0 for missing slots)
      const labels = [];
      const gasData = [];
      const elecData = [];
      for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 30) {
          const timeKey = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
          labels.push(timeKey);
          gasData.push(gasMap[timeKey] || 0);
          elecData.push(elecMap[timeKey] || 0);
        }
      }

      // Count readings for subtitle
      const gasCount = Object.keys(gasMap).length;
      const elecCount = Object.keys(elecMap).length;
      document.getElementById('halfHourlyGasTitle').textContent = `Half-Hourly Gas Usage (${dateLabel}) - ${gasCount}/48 readings`;
      document.getElementById('halfHourlyElecTitle').textContent = `Half-Hourly Electricity Usage (${dateLabel}) - ${elecCount}/48 readings`;

      // Gas chart
      const gasCtx = document.getElementById('halfHourlyGasChart').getContext('2d');
      if (halfHourlyGasChart) halfHourlyGasChart.destroy();

      halfHourlyGasChart = new Chart(gasCtx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Gas (kWh)',
            data: gasData,
            backgroundColor: gasData.map(v => v > 0 ? 'rgba(255, 112, 67, 0.7)' : 'rgba(255, 112, 67, 0.15)'),
            borderColor: '#ff7043',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.1)' },
              ticks: { color: '#888', maxTicksLimit: 12 }
            },
            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888' } }
          },
          plugins: { legend: { display: false } }
        }
      });

      // Electricity chart
      const elecCtx = document.getElementById('halfHourlyElecChart').getContext('2d');
      if (halfHourlyElecChart) halfHourlyElecChart.destroy();

      halfHourlyElecChart = new Chart(elecCtx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Electricity (kWh)',
            data: elecData,
            backgroundColor: elecData.map(v => v > 0 ? 'rgba(149, 117, 205, 0.7)' : 'rgba(149, 117, 205, 0.15)'),
            borderColor: '#9575cd',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.1)' },
              ticks: { color: '#888', maxTicksLimit: 12 }
            },
            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888' } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    async function pollEnergy() {
      try {
        await fetch('/api/energy/poll');
        await loadEnergyData();
      } catch (error) {
        console.error('Error polling energy:', error);
      }
    }

    // Water chart
    let waterChart = null;

    async function loadWaterData() {
      const days = parseInt(document.getElementById('waterDays').value);

      try {
        const [summaryRes, dailyRes] = await Promise.all([
          fetch('/api/water/summary'),
          fetch(`/api/water/daily?days=${days}`)
        ]);

        const summary = await summaryRes.json();
        const daily = await dailyRes.json();

        // Check if we have data
        const hasData = daily.length > 0;
        document.getElementById('waterNoData').style.display = hasData ? 'none' : 'block';

        // Update stats
        updateWaterStats(summary, daily);

        // Render chart
        if (hasData) {
          renderWaterChart(daily);
        }

      } catch (error) {
        console.error('Error loading water data:', error);
        document.getElementById('waterNoData').style.display = 'block';
      }
    }

    function updateWaterStats(summary, daily) {
      document.getElementById('waterYesterday').textContent =
        summary.yesterday_litres ? summary.yesterday_litres : '--';
      document.getElementById('waterAvg').textContent =
        summary.avg_daily_litres ? summary.avg_daily_litres : '--';
      document.getElementById('waterWeek').textContent =
        summary.week_litres ? summary.week_litres : '--';
      document.getElementById('waterMonth').textContent =
        summary.month_litres ? summary.month_litres : '--';
    }

    function renderWaterChart(data) {
      const ctx = document.getElementById('waterChart').getContext('2d');

      if (waterChart) waterChart.destroy();

      const labels = data.map(d => {
        const date = new Date(d.reading_date);
        return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
      });

      const litres = data.map(d => d.consumption_litres);

      // Calculate average for reference line
      const avgLitres = litres.reduce((a, b) => a + b, 0) / litres.length;

      waterChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Litres',
            data: litres,
            backgroundColor: 'rgba(33, 150, 243, 0.7)',
            borderColor: '#2196f3',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            annotation: {
              annotations: {
                averageLine: {
                  type: 'line',
                  yMin: avgLitres,
                  yMax: avgLitres,
                  borderColor: 'rgba(255, 255, 255, 0.5)',
                  borderWidth: 2,
                  borderDash: [5, 5],
                  label: {
                    display: true,
                    content: `Avg: ${Math.round(avgLitres)}L`,
                    position: 'end'
                  }
                }
              }
            }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.1)' },
              ticks: { color: '#888' }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.1)' },
              ticks: {
                color: '#888',
                callback: v => v + ' L'
              },
              beginAtZero: true
            }
          }
        }
      });
    }

    async function pollWater() {
      try {
        await fetch('/api/water/poll');
        await loadWaterData();
      } catch (error) {
        console.error('Error polling water:', error);
      }
    }

    // Initial load
    updateClock();
    setInterval(updateClock, 1000);
    fetchData();
    setInterval(fetchData, 30000);
  </script>
</body>
</html>
